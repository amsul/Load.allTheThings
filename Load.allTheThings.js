// Generated by CoffeeScript 1.3.3

/*
     __                           __                ___    ___  ______  __              ______  __
    /\ \                         /\ \              /\_ \  /\_ \/\__  _\/\ \            /\__  _\/\ \      __
    \ \ \        ___      __     \_\ \         __  \//\ \ \//\ \/_/\ \/\ \ \___      __\/_/\ \/\ \ \___ /\_\    ___      __     ____
     \ \ \  __  / __`\  /'__`\   /'_` \      /'__`\  \ \ \  \ \ \ \ \ \ \ \  _ `\  /'__`\ \ \ \ \ \  _ `\/\ \ /' _ `\  /'_ `\  /',__\
      \ \ \L\ \/\ \L\ \/\ \L\.\_/\ \L\ \  __/\ \L\.\_ \_\ \_ \_\ \_\ \ \ \ \ \ \ \/\  __/  \ \ \ \ \ \ \ \ \ \/\ \/\ \/\ \L\ \/\__, `\
       \ \____/\ \____/\ \__/.\_\ \___,_\/\_\ \__/.\_\/\____\/\____\\ \_\ \ \_\ \_\ \____\  \ \_\ \ \_\ \_\ \_\ \_\ \_\ \____ \/\____/
        \/___/  \/___/  \/__/\/_/\/__,_ /\/_/\/__/\/_/\/____/\/____/ \/_/  \/_/\/_/\/____/   \/_/  \/_/\/_/\/_/\/_/\/_/\/___L\ \/___/
                                                                                                                         /\____/
                                                                                                                         \_/__/
    ==================================================================================================================================
    ----------------------------------------------------------------------------------------------------------------------------------
*/


/*!
    Load.allTheThings v0.4.0 - 21 August, 2012

    (c) Amsul Naeem, 2012 - http://amsul.ca
    Licensed under MIT ("expat" flavour) license.
    Hosted on http://github.com/amsul/Load.allTheThings

    This library creates a Load object which can be used to
    preload things before they are needed on your page. It can
    load images, fonts, stylesheets, scripts, and html.

    To invoke the loader, use Load.allTheThings()
    For more documentation, check http://github.com/amsul/Load.allTheThings
*/


/*jshint debug: true, browser: true, devel: true, curly: false, forin: false, nonew: true, plusplus: false
*/


(function() {
  var Load,
    __hasProp = {}.hasOwnProperty;

  Load = (function() {
    var self;

    function Load() {}

    self = {};

    /*
        Load all the things!
        ========================================================================
    */


    Load.allTheThings = function(options) {
      self.beginLoading(options);
      return Load;
    };

    /*
        When loading begins, do some things
        ========================================================================
    */


    self.beginLoading = function(options) {
      var key, thingType, value, _i, _len, _ref, _ref1;
      self.PROGRESS = 0;
      self.THINGS = 0;
      self.THINGS_LOADED = 0;
      options = options || {};
      Load.options = options;
      self.defaults = {
        thingsToLoad: ['images', 'fonts', 'css', 'js', 'html'],
        progressId: null,
        thingsId: null,
        thingsLoadedId: null,
        onError: function(thing) {
          return Load;
        },
        onLoad: function(thing) {
          return Load;
        },
        onComplete: function() {
          return Load;
        }
      };
      _ref = self.defaults;
      for (key in _ref) {
        if (!__hasProp.call(_ref, key)) continue;
        value = _ref[key];
        Load.options[key] = options[key] || value;
      }
      Load.elemProgress = Load.options.progressId ? document.getElementById(Load.options.progressId) : null;
      Load.elemThings = Load.options.thingsId ? document.getElementById(Load.options.thingsId) : null;
      Load.elemThingsLoaded = Load.options.thingsLoadedId ? document.getElementById(Load.options.thingsLoadedId) : null;
      if (Load.elemThingsLoaded) {
        Load.elemThingsLoaded.innerHTML = self.THINGS_LOADED;
      }
      if (Load.elemProgress) {
        Load.elemProgress.innerHTML = self.PROGRESS;
      }
      _ref1 = Load.options.thingsToLoad;
      for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
        thingType = _ref1[_i];
        self.loadThings(thingType);
      }
      if (Load.elemThings) {
        Load.elemThings.innerHTML = self.THINGS;
      }
      return self;
    };

    /*
        Load things based on type of things
        ========================================================================
    */


    self.loadThings = function(type) {
      var selector, thing, things, _i, _len, _ref;
      things = {};
      selector = (function() {
        switch (type) {
          case 'images':
            return 'img';
          case 'fonts':
            return 'font';
          case 'css':
            return 'link';
          case 'js':
            return 'script';
          case 'html':
            return 'section';
          default:
            throw 'Thing type \'' + type + '\' is unknown';
        }
      })();
      things.all = document.querySelectorAll(selector);
      things.count = 0;
      things.filter = function(thing) {
        if (thing.dataset && thing.dataset.src) {
          things.load(thing);
        }
        return things;
      };
      things.load = function(thing) {
        var font;
        things.count += 1;
        if (type === 'fonts') {
          font = new Font();
          self.addHandlers(font, type);
          font.fontFamily = thing.dataset.family;
          font.src = thing.dataset.src;
        } else {
          self.addHandlers(thing, type);
          if (type === 'css') {
            thing.href = thing.dataset.src;
          } else {
            thing.src = thing.dataset.src;
          }
        }
        return things;
      };
      _ref = things.all;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        thing = _ref[_i];
        things.filter(thing);
      }
      self.THINGS += things.count;
      return self;
    };

    /*
        Update the progress as things load
        ========================================================================
    */


    self.thingLoaded = function(thing, type, content) {
      self.THINGS_LOADED += 1;
      self.PROGRESS = self.THINGS_LOADED / self.THINGS * 100;
      if (Load.elemProgress) {
        Load.elemProgress.innerHTML = self.PROGRESS;
      }
      if (Load.elemThingsLoaded) {
        Load.elemThingsLoaded.innerHTML = self.THINGS_LOADED;
      }
      if (type === 'html') {
        thing.innerHTML = content;
      }
      Load.options.onLoad(thing);
      if (self.THINGS_LOADED === self.THINGS) {
        self.loadComplete();
      }
      return self;
    };

    /*
        Update the progress as things load
        ========================================================================
    */


    self.loadComplete = function() {
      Load.options.onComplete();
      return self;
    };

    /*
        Bind and unbind some events
        ========================================================================
    */


    self.bind = function(thing, listener, handler) {
      thing.addEventListener(listener, handler, false);
      return self;
    };

    self.unbind = function(thing, listener, handler) {
      thing.removeEventListener(listener, handler);
      return self;
    };

    /*
        Add and remove handlers
        ========================================================================
    */


    self.addHandlers = function(thing, type) {
      var onError, onLoad, request;
      if (type === 'images' || type === 'css' || type === 'js') {
        self.commonHandlers(thing, type);
      } else if (type === 'fonts') {
        onLoad = function() {
          self.removeHandlers(thing, type).thingLoaded(thing, type);
        };
        onError = function() {
          self.removeHandlers(thing, type);
          Load.options.onError(thing);
        };
        thing.onload = onLoad;
        thing.onerror = onError;
      } else if (type === 'html') {
        request = new XMLHttpRequest();
        request.onload = function(e) {
          self.removeHandlers(request, type).thingLoaded(thing, type, request.responseText);
        };
        request.onreadystatechange = function(e) {
          if (request.readyState === 4 && request.status === 200) {
            self.removeHandlers(request, type).thingLoaded(thing, type, request.responseText);
          }
        };
        request.onerror = function() {
          self.removeHandlers(request, type);
          console.log('onerror', thing, type);
        };
        request.open('GET', thing.dataset.src, true);
        request.send();
      } else {
        console.log('no add handler', thing, type);
      }
      return self;
    };

    self.removeHandlers = function(thing, type) {
      if (type === 'images' || type === 'css' || type === 'js') {
        self.unbind(thing, 'load', thing.onLoad).unbind(thing, 'readyStateChange', thing.onReadyStateChange).unbind(thing, 'error', thing.onError);
      } else if (type === 'fonts') {
        thing.onload = function() {};
        thing.onerror = function() {};
      } else if (type === 'html') {
        thing.onload = function() {};
        thing.onreadystatechange = function() {};
        thing.onerror = function() {};
      } else {
        console.log('no remove handler', thing, type);
      }
      return self;
    };

    self.commonHandlers = function(thing, type) {
      var onError, onLoad, onReadyStateChange;
      onLoad = function(e) {
        self.removeHandlers(thing, type).thingLoaded(thing, type);
      };
      onReadyStateChange = function(e) {
        if (thing.readyState === 'complete') {
          self.removeHandlers(thing, type).thingLoaded(thing, type);
        }
        console.log('onReadyStateChange', e);
      };
      onError = function(e) {
        self.removeHandlers(thing, type);
        Load.options.onError(thing);
      };
      self.bind(thing, 'load', onLoad).bind(thing, 'readyStateChange', onReadyStateChange).bind(thing, 'error', onError);
      return self;
    };

    /*
        Intialize the loading
        ========================================================================
    */


    self.initialize = (function() {
      if (!window.Font || !window.Font.prototype.isLoadDotFonts) {
        throw 'Load.fonts is required for Load.allTheThings to work.';
      }
      window.Load = Load;
      return self;
    })();

    return Load;

  })();

}).call(this);
